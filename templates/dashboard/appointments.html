{% extends 'dashboard/layout.html' %}

{% block title %}Meus Agendamentos - AutoV7{% endblock %}

{% block dashboard_content %}
<!-- Header -->
<header class="dashboard-header">
    <div class="dashboard-header-content">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="dashboard-header-title">Meus Agendamentos</h1>
                <p class="dashboard-header-subtitle">Hist√≥rico completo dos seus servi√ßos de lavagem e est√©tica automotiva</p>
                <!-- DEBUG: Info do usu√°rio logado -->
                <p class="text-xs text-gray-500 mt-1">üîí Visualizando apenas agendamentos de: {{ user.username }} (ID: {{ user.id }})</p>
            </div>
            <a href="/dashboard/booking/" class="dashboard-btn dashboard-btn-primary">
                <i data-lucide="plus"></i>
                <span>Novo Agendamento</span>
            </a>
        </div>
    </div>
</header>

<div class="dashboard-content">
    <div class="dashboard-content-inner">
        <!-- Statistics -->
        <div class="dashboard-stats-grid dashboard-mb-8">
            <div class="dashboard-stat-card">
                <div class="dashboard-stat-icon primary">
                    <i data-lucide="calendar" class="w-8 h-8"></i>
                </div>
                <div class="dashboard-stat-content">
                    <p class="dashboard-stat-label">Total de Agendamentos</p>
                    <p class="dashboard-stat-value">{{ total_appointments }}</p>
                </div>
            </div>

            <div class="dashboard-stat-card">
                <div class="dashboard-stat-icon success">
                    <i data-lucide="check-circle" class="w-8 h-8"></i>
                </div>
                <div class="dashboard-stat-content">
                    <p class="dashboard-stat-label">Servi√ßos Conclu√≠dos</p>
                    <p class="dashboard-stat-value">{{ completed_appointments }}</p>
                </div>
            </div>

            <div class="dashboard-stat-card">
                <div class="dashboard-stat-icon warning">
                    <i data-lucide="clock" class="w-8 h-8"></i>
                </div>
                <div class="dashboard-stat-content">
                    <p class="dashboard-stat-label">Aguardando Atendimento</p>
                    <p class="dashboard-stat-value">{{ pending_appointments }}</p>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="dashboard-card dashboard-mb-6">
            <div class="dashboard-card-body">
                <form method="get" class="flex flex-wrap items-end gap-4">
                    <div class="flex-1 min-w-[200px]">
                        <label for="status" class="block text-sm font-semibold text-gray-700 mb-2">Filtrar por Status</label>
                        <select name="status" id="status" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <option value="">Todos os Status</option>
                            {% for value, label in status_choices %}
                                <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <button type="submit" class="dashboard-btn dashboard-btn-primary">
                            <i data-lucide="search" class="w-4 h-4"></i>
                            <span>Filtrar</span>
                        </button>
                    </div>
                    {% if request.GET.status %}
                    <div>
                        <a href="/dashboard/appointments/" class="dashboard-btn dashboard-btn-secondary">
                            <i data-lucide="x" class="w-4 h-4"></i>
                            <span>Limpar Filtro</span>
                        </a>
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>

        <!-- Appointments List -->
        {% if appointments %}
        <div class="dashboard-appointments-list">
            {% for appointment in appointments %}
            <div class="dashboard-appointment-card status-{{ appointment.situacao }}">
                <div class="dashboard-appointment-header">
                    <div class="dashboard-appointment-info">
                        <div class="dashboard-appointment-icon">
                            <i data-lucide="calendar-check" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h3 class="dashboard-appointment-title">Agendamento #{{ appointment.id }}</h3>
                            <p class="dashboard-appointment-datetime">
                                <i data-lucide="calendar" class="w-4 h-4 inline"></i>
                                {{ appointment.data_agendamento|date:"d/m/Y" }} √†s {{ appointment.horario_agendamento }}
                            </p>
                            <p class="text-xs text-gray-500 mt-1">
                                <i data-lucide="clock" class="w-3 h-3 inline"></i>
                                Solicitado em {{ appointment.criado_em|date:"d/m/Y √†s H:i" }}
                            </p>
                            <!-- DEBUG: Mostrar dono do agendamento -->
                            <p class="text-xs text-red-600 font-bold mt-1 border border-red-300 bg-red-50 px-2 py-1 rounded">
                                üîç DEBUG - Cliente: {{ appointment.usuario.username }} (ID: {{ appointment.usuario.id }})
                            </p>
                        </div>
                    </div>
                    <span class="dashboard-badge status-{{ appointment.situacao }}">
                        {% if appointment.situacao == 'pending' %}‚è≥ Pendente
                        {% elif appointment.situacao == 'confirmed' %}‚úì Confirmado
                        {% elif appointment.situacao == 'in_progress' %}üîÑ Em Andamento
                        {% elif appointment.situacao == 'completed' %}‚úÖ Conclu√≠do
                        {% elif appointment.situacao == 'cancelled' %}‚ùå Cancelado
                        {% else %}{{ appointment.get_situacao_display }}{% endif %}
                    </span>
                </div>

                <div class="dashboard-appointment-body">
                    <div class="dashboard-appointment-grid">
                        <!-- Vehicle Info -->
                        <div class="dashboard-card">
                            <div class="dashboard-card-header">
                                <h4 class="text-sm font-semibold text-gray-700">
                                    <i data-lucide="car" class="w-4 h-4 inline mr-1"></i>
                                    Ve√≠culo
                                </h4>
                            </div>
                            <div class="dashboard-card-body">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                                        <i data-lucide="car" class="w-6 h-6 text-white"></i>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-900">
                                            {{ appointment.veiculo.marca }} {{ appointment.veiculo.modelo }}
                                        </p>
                                        <p class="text-sm text-gray-600">
                                            {{ appointment.veiculo.ano }} ‚Ä¢ {{ appointment.veiculo.placa }}
                                        </p>
                                        {% if appointment.veiculo.cor %}
                                        <p class="text-xs text-gray-500">Cor: {{ appointment.veiculo.cor }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Services -->
                        <div class="dashboard-card">
                            <div class="dashboard-card-header">
                                <h4 class="text-sm font-semibold text-gray-700">
                                    <i data-lucide="sparkles" class="w-4 h-4 inline mr-1"></i>
                                    Servi√ßos Contratados
                                </h4>
                            </div>
                            <div class="dashboard-card-body">
                                <div class="space-y-2">
                                    {% for service_item in appointment.appointment_services.all %}
                                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm font-medium text-gray-900">{{ service_item.servico.nome }}</span>
                                            {% if service_item.concluido %}
                                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                                    <i data-lucide="check" class="w-3 h-3 mr-1"></i>
                                                    Conclu√≠do
                                                </span>
                                            {% endif %}
                                        </div>
                                        <span class="text-sm font-semibold text-green-600">R$ {{ service_item.preco|floatformat:2 }}</span>
                                    </div>
                                    {% empty %}
                                    <p class="text-sm text-gray-500 italic">Nenhum servi√ßo espec√≠fico registrado</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if appointment.observacoes %}
                    <div class="dashboard-card dashboard-mt-4">
                        <div class="dashboard-card-header">
                            <h4 class="text-sm font-semibold text-gray-700">
                                <i data-lucide="message-square" class="w-4 h-4 inline mr-1"></i>
                                Observa√ß√µes
                            </h4>
                        </div>
                        <div class="dashboard-card-body">
                            <p class="text-sm text-gray-700">{{ appointment.observacoes }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="dashboard-appointment-footer">
                    <div class="flex items-center gap-4">
                        <div class="dashboard-appointment-price">
                            R$ {{ appointment.preco_total|floatformat:2 }}
                        </div>
                        {% if appointment.posicao_fila %}
                        <div class="text-sm text-gray-600">
                            <i data-lucide="users" class="w-4 h-4 inline"></i>
                            Posi√ß√£o: {{ appointment.posicao_fila }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="dashboard-appointment-actions">
                        {% if appointment.situacao == 'pending' or appointment.situacao == 'confirmed' %}
                        <button onclick="cancelAppointment({{ appointment.id }})" class="dashboard-btn dashboard-btn-danger">
                            <i data-lucide="x" class="w-4 h-4"></i>
                            <span>Cancelar</span>
                        </button>
                        {% endif %}
                        
                        {% if appointment.situacao == 'completed' %}
                        <button onclick="rateService({{ appointment.id }})" class="dashboard-btn dashboard-btn-primary">
                            <i data-lucide="star" class="w-4 h-4"></i>
                            <span>Avaliar</span>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="dashboard-card">
            <div class="dashboard-card-body">
                <div class="dashboard-empty-state">
                    <i data-lucide="calendar-x" class="dashboard-empty-icon"></i>
                    <h3 class="dashboard-empty-title">Nenhum agendamento encontrado</h3>
                    <p class="dashboard-empty-description">
                        {% if request.GET.status %}
                            N√£o h√° agendamentos com o status selecionado.
                        {% else %}
                            Voc√™ ainda n√£o possui agendamentos. Agende sua primeira lavagem conosco!
                        {% endif %}
                    </p>
                    <a href="/dashboard/booking/" class="dashboard-btn dashboard-btn-primary">
                        <i data-lucide="plus"></i>
                        <span>Agendar Primeiro Servi√ßo</span>
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Inicializar √≠cones Lucide
lucide.createIcons();

function cancelAppointment(appointmentId) {
    if (confirm('Tem certeza que deseja cancelar este agendamento?\n\nEsta a√ß√£o n√£o pode ser desfeita.')) {
        fetch(`/dashboard/api/appointment/${appointmentId}/cancel/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Agendamento cancelado com sucesso!');
                location.reload();
            } else {
                alert('‚ùå Erro ao cancelar: ' + (data.error || 'Tente novamente mais tarde.'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('‚ùå Erro ao cancelar agendamento. Tente novamente.');
        });
    }
}

function rateService(appointmentId) {
    alert('üåü Sistema de avalia√ß√£o ser√° implementado em breve!\n\nEm breve voc√™ poder√° avaliar nossos servi√ßos e nos ajudar a melhorar.');
}
</script>
{% endblock %}
